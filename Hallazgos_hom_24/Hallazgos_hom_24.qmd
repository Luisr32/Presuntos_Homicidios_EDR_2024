---
title: "Pres_Homicidios_2024"
author: "Luis Ramírez"
format: html
editor: visual
---

## Posibles hallazgos sobre homicidios en 2024.

En este .qmd realizo el analisis bivariado para los casos de presuntos homicidios en la Estadistica de Defunciones Registrados para 2024 publicada por el INEGI. A cintinuación se enlistan los pasos de exploración y hallazgos relevanytes que concluyen con su respectiva visualización.

## Librerías

```{r}
library(tidyverse)
library(ggplot2)
library(foreign)
library(janitor)
library (scales)
library(dplyr)
library (showtext)
```

## Revisión de datos disponibles

```{r}
homicidios_23_24 <- readRDS("C:/Users/ramir/OneDrive/Documents/GitHub/Presuntos_Homicidios_EDR_2024/data/homicidios_23_24_min.rds")
nrow(homicidios_23_24)

# El archivo obtenido de la extracción de microdatos para presuntos homicidios los hice tanto para 2023 como para 2024, por si en algún momento hago un analisis comparativo entre años, de momento agrego esta linea para dejar fijos los homicidios del 2024.

homicidios24 <- homicidios_23_24 |> filter(anio == 2024)
names(homicidios24)
```

# Parentezco

Revisión del archivo de PARENTESCO.dbf para entender la relación del código en la base de presuntos homicidios para 2024. En esta parte estaba buscando hacer un analisis bivariado entre el sexo de la persona y su parentesco con el agresor, sin embargo, al revisar los datos, cais la totalidad de los mismos ni tienen un agresor registrado, por lo que no se pueden analizar, o al menos no como lo planteaba. Dejo el código como evidencia.

```{r}
#Esto me deja ver el catalogo de opciones de posible parentesco entre la víctima y el agresor.
parentesco <- read.dbf(
  "C:/Users/ramir/OneDrive/Documents/Luis/Trabajo/Data_Cívica/Segundo Ejercicio/2024EDR/PARENTESCO.dbf",
  as.is = TRUE
) |> 
  clean_names()

#El catalogo es muy grande, pero se puede reagrupar en grupos mas reconocibles integrados por el mismo tipo de parentesco.

homicidios24 <- homicidios24 |>
  mutate(
    parentesco_grupo = case_when(
      par_agre %in% c(11,12,45,46,47,48,49,50,51,52) ~ "Pareja / ex-pareja",

      par_agre %in% c(
        1:10, 13:44, 53:60, 70
      ) ~ "Familiar",

      par_agre %in% c(61:69) ~ "Conocido / relación social",

      par_agre %in% c(71,72) ~ "Sin parentesco",

      par_agre %in% c(88,98,99) ~ "No especificado",

      TRUE ~ "No especificado"
    )
  )

grupo_resumen <- homicidios24 |>
  count(parentesco_grupo) |>
  mutate(porc = n / sum(n))

#El resumen muestra que casi la totalidad de los datos no tienen específicado el agresor, estos datos no pueden ser utilizados para el analisis.
```

# Lugar de ocurrencia en comparativo por sexo.

Durante la revisión del catalogo de variables de la EDR, encontré la variable de lugar_ocur que desgloza el presunto homicidio por lugar en el que ocurrió. Aqui haré un analisis bivariado entre el sexo (hombre, mujer) y el lugar donde ocurrió el homicidio.

```{r}
#Revisé la relación en el catalogo de opciones de lugar de ocurrencia, habiendo varios espacios posibles, lo reduje a grupos conjuntos de espacios que se definen entre público y privado, esperando ver si en relación con el sexo hay algun comportamiento diferenciado.

homicidios24 <- homicidios24 |>
  mutate(
    # Asegurar tipo
    lugar_ocur = as.integer(lugar_ocur),

    # Etiquetas de sexo
    sexo_lbl = case_when(
      sexo == 1 ~ "Hombres",
      sexo == 2 ~ "Mujeres",
      #sexo == 9 ~ "No identificado", 
      TRUE ~ NA_character_
    ),

    # Agrupación del lugar de ocurrencia
    lugar_grp = case_when(
      lugar_ocur %in% c(1, 2) ~ "Vivienda",
      lugar_ocur %in% c(3, 4, 5, 6, 7, 8) ~ "Espacio público",
      lugar_ocur == 9 ~ "Otro",
      lugar_ocur == 0 ~ "No especificado",
      TRUE ~ NA_character_
    )
  )

   

lugar_resumen <- homicidios24 |>
  filter(!is.na(lugar_grp)) |>
  count(sexo, lugar_grp) |>
  group_by(sexo) |>
  mutate(porc = n / sum(n))
```


### Acomodo de datos y graficación
 
```{r}
cols <- c("Mujeres" = "#BF3EFF", "Hombres" = "#90EE90")

homicidios_lugar_sexo24 <- homicidios24 |>
  filter(sexo_lbl %in% c("Mujeres", "Hombres")) |>
  filter(!is.na(lugar_grp)) |>
  count(sexo_lbl, lugar_grp, name = "n") |>
  group_by(sexo_lbl) |>
  mutate(
    porc = n / sum(n),
    porc_plot = ifelse(sexo_lbl == "Mujeres", -porc, porc),
    label = percent(porc, accuracy = 0.1),
    cabe = porc >= 0.10,
    x_text = ifelse(
      cabe,
      porc_plot * 0.55,
      ifelse(sexo_lbl == "Mujeres", -0.02, 0.02)
    ),
    hjust_text = ifelse(
      cabe,
      0.5,
      ifelse(sexo_lbl == "Mujeres", 1, 0)
    )
  ) |>
  ungroup() |>
  mutate(
    lugar_grp = factor(
      lugar_grp,
      levels = c("Vivienda", "Espacio público", "Otro", "No especificado")
    )
  )

homicidios_lugar_sexo24_plot <- ggplot(
  homicidios_lugar_sexo24,
  aes(x = porc_plot, y = lugar_grp, fill = sexo_lbl)
) +
  geom_col(width = 0.75, color = "grey15", linewidth = 0.3) +
  geom_text(
    aes(x = x_text, label = label, hjust = hjust_text),
    color = "black",
    family = "Montserrat",
    fontface = "bold",
    size = 8.5
  ) +
  scale_fill_manual(values = cols) +
  scale_x_continuous(labels = scales::percent, breaks = seq(-1, 1, 0.2)) +
  labs(
    title = "Lugar de ocurrencia del homicidio por sexo (2024)",
    subtitle = "Distribución porcentual dentro de cada sexo",
    x = "Porcentaje",
    y = NULL,
    fill = NULL
  ) +
  theme_minimal(base_family = "Montserrat") +
  theme(
    legend.position = "right",
    legend.title = element_blank(),
    legend.text = element_text(size = 16),

    plot.title = element_text(size = 28, face = "bold"),
    plot.subtitle = element_text(size = 18),

    axis.title.x = element_text(size = 20, margin = margin(t = 12)),
    axis.text.x  = element_text(size = 16),

    axis.text.y  = element_text(size = 18),

    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```
 
### Guardar graf de homicidios por sexo por lugar donde ocurrió.
 
```{r}
ggsave(
  filename = "homicidios_lugar_sexo24.jpeg",
  plot = homicidios_lugar_sexo24_plot,
  path = "C:/Users/ramir/OneDrive/Documents/GitHub/Presuntos_Homicidios_EDR_2024/Hallazgos_hom_24",
  width = 10,
  height = 6,
  units = "in",
  dpi = 200
)
```

#Entidad en la que las personas extranjeras 
Este es un analisis exploratorio de victimas de presunto homicidio con nacionalidad extranjera (=2) en busqueda de comprender si hay relación con personas extranjeras fallecidas y estados en ruta de migración.

### Preparación de datos
```{r}
entidades <- c(
  "Aguascalientes",
  "Baja California",
  "Baja California Sur",
  "Campeche",
  "Coahuila",
  "Colima",
  "Chiapas",
  "Chihuahua",
  "Ciudad de México",
  "Durango",
  "Guanajuato",
  "Guerrero",
  "Hidalgo",
  "Jalisco",
  "México",
  "Michoacán",
  "Morelos",
  "Nayarit",
  "Nuevo León",
  "Oaxaca",
  "Puebla",
  "Querétaro",
  "Quintana Roo",
  "San Luis Potosí",
  "Sinaloa",
  "Sonora",
  "Tabasco",
  "Tamaulipas",
  "Tlaxcala",
  "Veracruz",
  "Yucatán",
  "Zacatecas"
)

extranjeros_ent_ocurr24 <- homicidios24 |>
  #Aqui realizo el filtro de personas con nacionalidad extranjera, excluyendo  a personas mexicanas o sin nacionalidad registrada.
  filter(nacionalid == 2) |>
  mutate(ent_ocurr = as.numeric(ent_ocurr)) |>
  filter(!is.na(ent_ocurr), ent_ocurr >= 1, ent_ocurr <= 32) |>
  count(ent_ocurr, name = "n") |>
  mutate(
    entidad = entidades[ent_ocurr]
  ) |>
  arrange(desc(n)) |>
  slice_head(n = 10) |>
  mutate(
    entidad = stringr::str_wrap(entidad, width = 16),
    entidad = factor(entidad, levels = rev(entidad))
  )
```


### Graficación
```{r}
extranjeros_ent_ocurr24_plot <- ggplot(
  extranjeros_ent_ocurr24,
  aes(x = n, y = entidad)
) +
  geom_segment(
    aes(x = 0, xend = n, y = entidad, yend = entidad),
    linewidth = 1.2,
    color = "grey65"
  ) +
  geom_point(
    size = 8,
    color = "#BF3EFF"
  ) +
  geom_text(
    aes(label = n),
    size = 6,                
    family = "Montserrat",
    fontface = "bold",
    color = "black",
    hjust = 0.5,
    vjust = 0.5
  ) +
  scale_x_continuous(
    limits = c(0, max(extranjeros_ent_ocurr24$n) * 1.1),
    breaks = seq(0, 90, 10)
  ) +
  labs(
    title = "Homicidios de personas extranjeras por entidad (2024)",
    subtitle = "Entidad donde ocurrió la defunción · Top 10",
    x = "Número de homicidios de personas extranjeras",
    y = NULL
  ) +
  theme_minimal(base_family = "Montserrat") +
  theme(
    plot.title = element_text(size = 29, face = "bold"),
    plot.subtitle = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    axis.text.x = element_text(size = 26),
    axis.title.x = element_text(size = 32, margin = margin(t = 20)),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
extranjeros_ent_ocurr24_plot
```

### Guardar graf de top 10 homicidios por entidad para personas de nacionaldiad extranjera.
```{r}
ggsave(
  filename = "extranjeros_ent_ocurr24.jpeg",
  plot = extranjeros_ent_ocurr24_plot,
  path = "C:/Users/ramir/OneDrive/Documents/GitHub/Presuntos_Homicidios_EDR_2024/Hallazgos_hom_24",
  width = 10,
  height = 6,
  units = "in",
  dpi = 200,
  bg = "white"
)
```

#Homicidios para personas racializadas 
Este es un analisis exploratorio de victimas de presunto homicidio parte de la población racializada mexicana, incluyendo pueblos originarios y afromexicanas.

### Preparación de datos
```{r}
racializacion_24 <- homicidios24 |>
  filter(
    conindig %in% c(1, 2),
    afromex %in% c(1, 2)
  ) |>
  mutate(
    racializacion = case_when(
      conindig == 1 ~ "Personas indígenas",
      conindig == 2 & afromex == 1 ~ "Personas afromexicanas",
      TRUE ~ "Personas no racializadas"
    )
  ) |>
  count(racializacion, name = "n") |>
  mutate(
    porcentaje = n / sum(n)
  )
```


### Graficación
```{r}
racializacion_plot <- ggplot(
  racializacion_24,
  aes(x = racializacion, y = porcentaje, fill = racializacion)
) +
  geom_col(
    width = 0.65,
    color = "black",
    linewidth = 0.6
  ) +
  geom_text(
    aes(label = scales::percent(porcentaje, accuracy = 0.1)),
    vjust = -0.3,
    size = 14,
    family = "Montserrat",
    fontface = "bold",
    color = "black"
  ) +
  scale_y_continuous(
    labels = scales::percent,
    limits = c(0, 1),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_fill_manual(
    values = c(
      "Personas indígenas" = "#BF3EFF",
      "Personas afromexicanas" = "#FF8C00",
      "Personas no racializadas" = "#90EE90"
    )
  ) +
  labs(
    title = "Homicidios por condición de racialización (2024)",
    subtitle = "Adscripción indígena y autorreconocimiento afromexicano",
    x = NULL,
    y = "Porcentaje"
  ) +
  theme_minimal(base_family = "Montserrat") +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 48, face = "bold"),
    plot.subtitle = element_text(size = 34),
    axis.text.x = element_text(size = 34),
    axis.text.y = element_text(size = 30),
    axis.title.y = element_text(size = 36),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
racializacion_plot
```

### Guardar graf de top 10 homicidios por entidad para personas de nacionaldiad extranjera.
```{r}
ggsave(
  filename = "homicidios_racializacion_24.jpeg",
  plot = racializacion_plot,
  path = "C:/Users/ramir/OneDrive/Documents/GitHub/Presuntos_Homicidios_EDR_2024/Hallazgos_hom_24",
  width = 12,
  height = 8,
  units = "in",
  dpi = 300,
  bg = "white"
)
```